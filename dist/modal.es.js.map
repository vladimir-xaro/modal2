{"version":3,"file":"modal.es.js","sources":["../src/Helper.ts","../src/helpers.ts","../src/Modal.ts"],"sourcesContent":["import I_Helper from \"./types/Helper\";\n\nconst Helper = class implements I_Helper {\n  cb?: Function;\n}\n\nexport default Helper;","import { nextTick } from \"@xaro/micro-dom\";\nimport CSSClassAnimations from \"@xaro/css-class-animations\";\n\nexport const animate = (\n  animInst:   CSSClassAnimations,\n  from:       string,\n  active:     string,\n  to:         string,\n  afterEnd?:  Function,\n): void => {\n  animInst.els.addClass(from);\n\n  nextTick(\n    [\n      () => animInst.els.addClass(active),\n      10\n    ], [\n      () => animInst.els.removeClass(from),\n      10\n    ], [\n      () => {\n        animInst.emitter.once('end', () => {\n          animInst.els.removeClass(to, active)\n          afterEnd && afterEnd();\n        });\n        animInst.els.addClass(to);\n      },\n      10\n    ]\n  );\n}\n\nexport const undefinedBool = (val: any, def: boolean) => typeof val === 'undefined' ? def : val;","import CSSClassAnimations, { DOMEventsKeys as CSSAnimationsEventsKey } from \"@xaro/css-class-animations\";\nimport EventEmitter from \"@xaro/event-emitter\";\nimport deepmerge, { isObject } from \"@xaro/deepmerge\";\nimport Helper from \"./Helper\";\nimport { animate, undefinedBool } from \"./helpers\";\nimport I_Helper from \"./types/Helper\";\nimport {\n  Modal         as I_Modal,\n  ModalCfg      as I_ModalCfg,\n  ModalCtor     as I_ModalCtor,\n  ModalCtorCfg  as I_ModalCtorCfg\n} from \"./types/Modal\";\n\nconst defaultClasses = {\n  show:     'modal--show',\n  wrapper:  'modal__wrapper',\n  content:  'modal__content',\n  transition: {\n    hide: {\n      from:   'modal-t-hide-from',\n      active: 'modal-t-hide-active',\n      to:     'modal-t-hide-to',\n    },\n    show: {\n      from:   'modal-t-show-from',\n      active: 'modal-t-show-active',\n      to:     'modal-t-show-to',\n    },\n  }\n};\nconst defaultAttrs = {\n  modalId:  'data-modal-id',\n  close:    'data-modal-close',\n\n};\n\nconst Modal: I_ModalCtor = class implements I_Modal {\n  static instances: I_Modal[] = [];\n  static queue:     I_Modal[] = [];\n  static isFirst:   boolean = true;\n\n  emitter:      EventEmitter;\n  config:       I_ModalCfg;\n  helper:       I_Helper;\n  animContent?: CSSClassAnimations;\n\n  static addsEscListener() {\n    document.addEventListener('keyup', (event: KeyboardEvent) => {\n      let length;\n      if (event.code === 'Escape' && (length = Modal.queue.length)) {\n        Modal.queue[length - 1].hide()\n      }\n    });\n  }\n\n  static showById(id: string) {\n    if (id === undefined) {\n      return;\n    }\n    for (const modal of Modal.instances) {\n      if (id === modal.config.id) {\n        modal.show();\n        return;\n      }\n    }\n  }\n\n  constructor(config: I_ModalCtorCfg) {\n    if (Modal.isFirst) {\n      Modal.addsEscListener();\n\n      Modal.isFirst = false;\n    }\n\n    this.emitter = new EventEmitter(config.on);\n    \n    const _classes = isObject(config.classes) ?\n      deepmerge(defaultAttrs, config.classes) :\n      defaultClasses;\n    const _attrs = isObject(config.attrs) ?\n      deepmerge(defaultAttrs, config.attrs) :\n      defaultAttrs;\n    \n      this.config = {\n      el:             config.el,\n      wrapper:        config.el.querySelector(`.${_classes.wrapper}`),\n      content:        config.el.querySelector(`.${_classes.content}`),\n      isVisible:      false,\n      pending:        false,\n      mutation:       config.mutation || false,\n      attrClose:      undefinedBool(config.attrClose, true),\n      wrapperClick:   undefinedBool(config.wrapperClick, true),\n      allowEsc:       undefinedBool(config.allowEsc, true),\n      classes:        _classes,\n      attrs:          _attrs\n    };\n    let _id;\n    this.config.id = (_id = config.el.getAttribute(_attrs.modalId)) ? _id : undefined;\n\n    Modal.instances.push(this);\n\n    this.helper = new Helper;\n    if (this.config.mutation) {\n      this.animContent = new CSSClassAnimations({\n        el:     this.config.content,\n        allow:  this.config.mutation + 'end' as CSSAnimationsEventsKey,\n      })\n    }\n\n    if (this.config.attrClose) {\n      this.config.el.querySelectorAll(`[${this.config.attrs.close}]`).forEach(el => {\n        el.addEventListener('click', () => this.hide());\n      });\n    }\n\n    if (this.config.wrapperClick) {\n      this.config.wrapper.addEventListener('click', (event: Event) => {\n        if (event.target === this.config.wrapper) {\n          this.hide();\n        }\n      });\n    }\n\n    this.emitter.emit('init', this, this.config.isVisible);\n\n    if (config.showOnInit) {\n      this.show();\n    }\n  }\n\n  changeState(hide: boolean) {\n    if (this.config.pending) {\n      this.helper.cb = () => this.changeState(hide);\n      return;\n    }\n\n    this.config.isVisible = !hide;\n\n    if (this.config.mutation) {\n      this.config.pending = true;\n\n      if (hide) {\n        this.emitter.emit('beforeHide', this, this.config.mutation);\n\n        let qI = Modal.queue.indexOf(this);\n        Modal.queue.splice(qI, 1);\n\n        animate(\n          this.animContent,\n          this.config.classes.transition.hide.from,\n          this.config.classes.transition.hide.active,\n          this.config.classes.transition.hide.to,\n          () => {\n            this.config.el.classList.remove(this.config.classes.show);\n            this.config.pending = false;\n            const cb = this.helper.cb;\n            delete this.helper.cb;\n            this.emitter.emit('afterHide', this, this.config.mutation);\n            cb && cb(this);\n          }\n        );\n      } else {\n        this.emitter.emit('beforeShow', this, this.config.mutation);\n\n        Modal.queue.push(this);\n\n        this.config.el.classList.add(this.config.classes.show);\n        animate(\n          this.animContent,\n          this.config.classes.transition.show.from,\n          this.config.classes.transition.show.active,\n          this.config.classes.transition.show.to,\n          () => {\n            this.config.pending = false;\n            const cb = this.helper.cb;\n            delete this.helper.cb;\n            this.emitter.emit('afterShow', this, this.config.mutation);\n            cb && cb(this);\n          }\n        );\n      }\n    } else {\n      if (hide) {\n        this.emitter.emit('beforeHide', this, this.config.mutation);\n\n        let qI = Modal.queue.indexOf(this);\n        Modal.queue.splice(qI, 1);\n\n        this.config.el.classList.remove(this.config.classes.show);\n        this.emitter.emit('afterHide', this, this.config.mutation);\n      } else {\n        this.emitter.emit('beforeShow', this, this.config.mutation);\n\n        Modal.queue.push(this);\n\n        this.config.el.classList.add(this.config.classes.show);\n        this.emitter.emit('afterShow', this, this.config.mutation);\n      }\n    }\n  }\n\n  show(): void {\n    if (this.config.isVisible) {\n      return;\n    }\n\n    this.changeState(false);\n  }\n  hide() {\n    if (! this.config.isVisible) {\n      return;\n    }\n\n    this.changeState(true);\n  }\n\n  toggle() {\n    if (this.config.isVisible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n}\n\nexport default Modal;"],"names":["animate","animInst","from","active","to","afterEnd","els","addClass","nextTick","removeClass","emitter","once","undefinedBool","val","def","defaultClasses","show","wrapper","content","transition","hide","defaultAttrs","modalId","close","Modal","[object Object]","document","addEventListener","event","length","code","queue","id","undefined","modal","instances","config","isFirst","addsEscListener","this","EventEmitter","on","_classes","isObject","classes","deepmerge","_attrs","attrs","_id","el","querySelector","isVisible","pending","mutation","attrClose","wrapperClick","allowEsc","getAttribute","push","helper","animContent","CSSClassAnimations","allow","querySelectorAll","forEach","target","emit","showOnInit","cb","changeState","qI","indexOf","splice","classList","remove","add"],"mappings":"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"}