{"version":3,"file":"modal.es.js","sources":["../src/Helper.ts","../src/helpers.ts","../src/Modal.ts"],"sourcesContent":["import I_Helper from \"./types/Helper\";\n\nconst Helper = class implements I_Helper {\n  cb?: Function;\n}\n\nexport default Helper;","import { nextTick } from \"@xaro/micro-dom\";\nimport CSSClassAnimations from \"@xaro/css-class-animations\";\n\nexport const animate = (\n  animInst:   CSSClassAnimations,\n  from:       string,\n  active:     string,\n  to:         string,\n  afterEnd?:  Function,\n): void => {\n  animInst.els.addClass(from);\n\n  nextTick(\n    [\n      () => animInst.els.addClass(active),\n      10\n    ], [\n      () => animInst.els.removeClass(from),\n      10\n    ], [\n      () => {\n        animInst.emitter.once('end', () => {\n          animInst.els.removeClass(to, active)\n          afterEnd && afterEnd();\n        });\n        animInst.els.addClass(to);\n      },\n      10\n    ]\n  );\n}\n\nexport const undefinedBool = (val: any, def: boolean) => typeof val === 'undefined' ? def : val;","import CSSClassAnimations, {\n  DOMEventsKeys as CSSAnimationsEventsKey\n} from \"@xaro/css-class-animations\";\nimport EventEmitter from \"@xaro/event-emitter\";\nimport deepmerge, { isObject } from \"@xaro/deepmerge\";\nimport HelperCtor from \"./Helper\";\nimport Helper from \"./types/Helper\";\nimport { animate, undefinedBool } from \"./helpers\";\nimport I_Modal, {\n  ModalCfg,\n  ModalChangeCfg,\n  ModalCtorCfg,\n  ModalHideCfg,\n  ModalShowCfg\n} from \"./types/Modal\";\n\nconst defaultClasses = {\n  show:     'modal--show',\n  wrapper:  'modal__wrapper',\n  content:  'modal__content',\n  transition: {\n    hide: {\n      from:   'modal-t-hide-from',\n      active: 'modal-t-hide-active',\n      to:     'modal-t-hide-to',\n    },\n    show: {\n      from:   'modal-t-show-from',\n      active: 'modal-t-show-active',\n      to:     'modal-t-show-to',\n    },\n  }\n};\n\nconst defaultAttrs = {\n  modalId:  'data-modal-id',\n  close:    'data-modal-close',\n};\n\nexport default class Modal implements I_Modal {\n  static instances: Modal[] = [];\n  static queue:     Modal[] = [];\n  static isFirst:   boolean = true;\n\n  static addsEscListener() {\n    document.addEventListener('keyup', (event: KeyboardEvent) => {\n      let length;\n      if (event.code === 'Escape' && (length = Modal.queue.length)) {\n        Modal.queue[length - 1].hide()\n      }\n    });\n  }\n\n  static showById(id: string) {\n    if (id === undefined) {\n      return;\n    }\n    for (const modal of Modal.instances) {\n      if (id === modal.config.id) {\n        modal.show();\n        return;\n      }\n    }\n  }\n\n  emitter:      EventEmitter;\n  config:       ModalCfg;\n  helper:       Helper;\n  animContent?: CSSClassAnimations;\n  bluredEl?:    Element;\n\n  constructor(config: ModalCtorCfg) {\n    // First init\n    if (Modal.isFirst) {\n      Modal.addsEscListener();\n\n      Modal.isFirst = false;\n    }\n\n    const el = config.el;\n\n    // Checks if an instance with this element exists\n    if (el.__modalIsInit) {\n      for (const modal of Modal.instances) {\n        if (el === modal.config.el) {\n          return modal;\n        }\n      }\n    } else {\n      el.__modalIsInit = true;\n    }\n\n    this.emitter = new EventEmitter(config.on);\n    \n    const _classes = isObject(config.classes) ?\n      deepmerge(defaultAttrs, config.classes) :\n      defaultClasses;\n    const _attrs = isObject(config.attrs) ?\n      deepmerge(defaultAttrs, config.attrs) :\n      defaultAttrs;\n    \n    this.config = {\n      el:             el,\n      wrapper:        el.querySelector(`.${_classes.wrapper}`),\n      content:        el.querySelector(`.${_classes.content}`),\n      isVisible:      false,\n      pending:        false,\n      mutation:       config.mutation || false,\n      attrClose:      undefinedBool(config.attrClose, true),\n      wrapperClick:   undefinedBool(config.wrapperClick, true),\n      allowEsc:       undefinedBool(config.allowEsc, true),\n      classes:        _classes,\n      attrs:          _attrs\n    };\n    let _id;\n    this.config.id = (_id = el.getAttribute(_attrs.modalId)) ? _id : undefined;\n\n    Modal.instances.push(this);\n\n    this.helper = new HelperCtor;\n    if (this.config.mutation) {\n      this.animContent = new CSSClassAnimations({\n        el:     this.config.content,\n        allow:  this.config.mutation + 'end' as CSSAnimationsEventsKey,\n      })\n    }\n\n    if (this.config.attrClose) {\n      this.config.el.querySelectorAll(`[${this.config.attrs.close}]`).forEach(el => {\n        el.addEventListener('click', () => this.hide());\n      });\n    }\n\n    if (this.config.wrapperClick) {\n      this.config.wrapper.addEventListener('click', (event: Event) => {\n        if (event.target === this.config.wrapper) {\n          this.hide();\n        }\n      });\n    }\n\n    this.emitter.emit('init', this, this.config.isVisible);\n\n    if (config.showOnInit) {\n      this.show();\n    }\n  }\n\n  changeState(hide: boolean, config?: ModalChangeCfg) {\n    if (this.config.pending) {\n      this.helper.cb = () => this.changeState(hide);\n      return;\n    }\n\n    this.config.isVisible = !hide;\n\n    if (this.config.mutation) {\n      this.config.pending = true;\n\n      if (hide) {\n        this.emitter.emit('beforeHide', this, this.config.mutation);\n\n        let qI = Modal.queue.indexOf(this);\n        Modal.queue.splice(qI, 1);\n\n        animate(\n          this.animContent,\n          this.config.classes.transition.hide.from,\n          this.config.classes.transition.hide.active,\n          this.config.classes.transition.hide.to,\n          () => {\n            this.config.el.classList.remove(this.config.classes.show);\n            this.config.pending = false;\n            const cb = this.helper.cb;\n            delete this.helper.cb;\n            this.emitter.emit('afterHide', this, this.config.mutation);\n            cb && cb(this);\n          }\n        );\n      } else {\n        this.emitter.emit('beforeShow', this, this.config.mutation);\n\n        Modal.queue.push(this);\n\n        this.config.el.classList.add(this.config.classes.show);\n        animate(\n          this.animContent,\n          this.config.classes.transition.show.from,\n          this.config.classes.transition.show.active,\n          this.config.classes.transition.show.to,\n          () => {\n            this.config.pending = false;\n            const cb = this.helper.cb;\n            delete this.helper.cb;\n            this.emitter.emit('afterShow', this, this.config.mutation);\n            cb && cb(this);\n          }\n        );\n      }\n    } else {\n      if (hide) {\n        this.emitter.emit('beforeHide', this, this.config.mutation);\n\n        let qI = Modal.queue.indexOf(this);\n        Modal.queue.splice(qI, 1);\n\n        this.config.el.classList.remove(this.config.classes.show);\n        this.emitter.emit('afterHide', this, this.config.mutation);\n      } else {\n        this.emitter.emit('beforeShow', this, this.config.mutation);\n\n        Modal.queue.push(this);\n\n        this.config.el.classList.add(this.config.classes.show);\n        this.emitter.emit('afterShow', this, this.config.mutation);\n      }\n    }\n  }\n\n  show(config?: ModalShowCfg): void {\n    if (this.config.isVisible) {\n      return;\n    }\n\n    this.bluredEl = document.activeElement;\n\n    this.changeState(false, config);\n  }\n  hide(config?: ModalHideCfg) {\n    if (! this.config.isVisible) {\n      return;\n    }\n\n    this.changeState(true, config);\n\n    if (config) {\n      if (config.focusBluredEl) {\n        (this.bluredEl as unknown as HTMLOrSVGElement).focus();\n        this.bluredEl = undefined;\n      }\n    }\n  }\n\n  toggle() {\n    if (this.config.isVisible) {\n      this.hide();\n    } else {\n      this.show();\n    }\n  }\n}"],"names":["animate","animInst","from","active","to","afterEnd","els","addClass","nextTick","removeClass","emitter","once","undefinedBool","val","def","defaultClasses","show","wrapper","content","transition","hide","defaultAttrs","modalId","close","Modal","[object Object]","document","addEventListener","event","length","code","queue","id","undefined","modal","instances","config","isFirst","addsEscListener","el","__modalIsInit","this","EventEmitter","on","_classes","isObject","classes","deepmerge","_attrs","attrs","_id","querySelector","isVisible","pending","mutation","attrClose","wrapperClick","allowEsc","getAttribute","push","helper","animContent","CSSClassAnimations","allow","querySelectorAll","forEach","target","emit","showOnInit","cb","changeState","qI","indexOf","splice","classList","remove","add","bluredEl","activeElement","focusBluredEl","focus"],"mappings":"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"}